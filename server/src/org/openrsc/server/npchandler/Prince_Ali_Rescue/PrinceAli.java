/**
* Generated By NPCScript :: A scripting engine created for openrsc by Zilent
*/
package org.openrsc.server.npchandler.Prince_Ali_Rescue;

import org.openrsc.server.model.World;
import org.openrsc.server.model.Npc;
import org.openrsc.server.model.InvItem;
import org.openrsc.server.event.DelayedQuestChat;
import org.openrsc.server.model.Player;
import org.openrsc.server.model.Quest;
import org.openrsc.server.npchandler.NpcHandler;

public class PrinceAli implements NpcHandler {

	public void handleNpc(final Npc npc, final Player owner) throws Exception {
		npc.blockedBy(owner);
		owner.setBusy(true);
		Quest q = owner.getQuest(10);
		if(q != null) {
			if(q.getStage() < 4) {
				error(npc, owner);
			} else {
				if(q.getStage() == 4) {
					if(owner.getInventory().countId(194) < 1 || owner.getInventory().countId(244) < 1 || owner.getInventory().countId(242) < 1 || owner.getInventory().countId(240) < 1) {
						failRescue(npc, owner);
					} else {
						rescuePrince(npc, owner);
					}
				} else {
					afterRelease(npc, owner);
				}
			}
		} else {
			error(npc, owner);
		}
	}
	
	private final void error(final Npc npc, final Player owner) {
		owner.setBusy(false);
		npc.unblock();
		System.out.println("Prince Ali was talked to at an invalid quest stage.");
	}
	
	private final void afterRelease(final Npc npc, final Player owner) {
		final String[] messages0 = {"I owe you my life for that escape", "You cannot help me this time, they know who you are", "Go in peace, friend of Al Kharid"};
		World.getDelayedEventHandler().add(new DelayedQuestChat(npc, owner, messages0, true) {
			public void finished() {
				owner.setBusy(false);
				npc.unblock();
			}
		});
	}
	
	private final void failRescue(final Npc npc, final Player owner) {
		final String[] messages0 = {"Prince, I come to rescue you"};
		World.getDelayedEventHandler().add(new DelayedQuestChat(owner, npc, messages0, true) {
			public void finished() {
				final String[] messages1 = {"That is very very kind of you, how do I get out?"};
				World.getDelayedEventHandler().add(new DelayedQuestChat(npc, owner, messages1) {
					public void finished() {
						final String[] messages2 = {"With a disguise, I have removed the Lady Keli", "She is tied up, but will not stay tied up for long"};
						World.getDelayedEventHandler().add(new DelayedQuestChat(owner, npc, messages2) {
							public void finished() {
								final String[] messages3 = {"You don't seem to have all I need to escape yet", "I dare not risk death to these people"};
								World.getDelayedEventHandler().add(new DelayedQuestChat(npc, owner, messages3) {
									public void finished() {
										owner.setBusy(false);
										npc.unblock();
									}
								});
							}
						});
					}
				});
			}
		});
	}

	private final void  rescuePrince(final Npc npc, final Player owner) {
		final String[] messages0 = {"Prince, I come to rescue you"};
		World.getDelayedEventHandler().add(new DelayedQuestChat(owner, npc, messages0, true) {
			public void finished() {
				final String[] messages1 = {"That is very kind of you, how do I get out?"};
				World.getDelayedEventHandler().add(new DelayedQuestChat(npc, owner, messages1) {
					public void finished() {
						final String[] messages2 = {"With a disguise, I have removed the Lady Keli", "She is tied up, but will not stay tied up for long", "Take this disguise, and this key"};
						owner.getInventory().remove(new InvItem(194, 1));
						owner.getInventory().remove(new InvItem(244, 1));
						owner.getInventory().remove(new InvItem(242, 1));
						owner.getInventory().remove(new InvItem(240, 1));
						owner.sendInventory();
						World.getDelayedEventHandler().add(new DelayedQuestChat(owner, npc, messages2) {
							public void finished() {
								npc.remove();
								final Npc girlyPrince = new Npc(126, npc.getX(), npc.getY(), npc.minX(), npc.maxX(), npc.minY(), npc.maxY());
								girlyPrince.setRespawn(false);
								World.registerEntity(girlyPrince);
								final String[] messages3 = {"Thankyou my friend, I must leave you now", "My father will pay you well for this"};
								World.getDelayedEventHandler().add(new DelayedQuestChat(girlyPrince, owner, messages3) {
									public void finished() {
										final String[] messages4 = {"Go to Leela, she is close to here"};
										World.getDelayedEventHandler().add(new DelayedQuestChat(owner, girlyPrince, messages4) {
											public void finished() {
												girlyPrince.remove();
												owner.incQuestCompletionStage(10);
												owner.sendMessage("The prince has escaped, well done!");
												owner.sendMessage("You are now a friend of Al kharid");
												owner.sendMessage("And may pass through the Al Kharid toll gate for free");
												owner.setBusy(false);
												npc.unblock();
											}
										});
									}
								});
							}
						});
					}
				});
			}
		});
	}
}